\documentclass[11pt]{article}
\usepackage{vmargin}
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{epstopdf}
\usepackage{epsfig}
\usepackage{alltt}
\usepackage{bm}
\usepackage{amsmath}
\DeclareGraphicsRule{.tif}{png}{.png}{`convert #1 `dirname #1`/`basename #1 .tif`.png}
\newcommand{\sbt}{\,\begin{picture}(-1,1)(-1,-3)\circle*{3}\end{picture}\ }
\newcommand{\ith}{$i^{th}$}

\textwidth = 6.5 in
\textheight = 9 in
\oddsidemargin = 0.5 in
\evensidemargin = 0.5 in
\parskip = 0.2in
\parindent = 0.0in

\def\arraystretch{1.25}

\newcommand*{\tabbox}[2][t]{%
    \vspace{0pt}\parbox[#1][3.7\baselineskip]{1cm}{\strut#2\strut}}
    
\title{CS652 Smalltalk VM Operational Semantics}
\author{Terence Parr}
\begin{document}
\maketitle

\begin{figure}
\begin{center}
\begin{tabular}{l p{8cm}}
$T \bowtie x$ & Resolve $x$ in scope $T$ \\

$o \in \text{\tt X}$ & $o$ instance of $X$\\

$o_{class} \in \text{\tt\small STMetaClassObject}$ & Metaclass (type) of object $o$\\

$o_{class_{class}}=o_{class}$ &  A metaclass object is its own type\\

$o_{superclass} \in \text{\tt\small STMetaClassObject}$ & Superclass (type) of object $o$\\

$o_{field_i}$ & The \ith field of object $o$ \\

$f_{literal_i}$ & The \ith literal of method $f$ \\

$f^{block_i}_s \in \text{\tt\small BlockDescriptor}$ & The \ith block of method $f$ associated with instance self=$s$\\

$f^{block_i}_s[\_,\_,\_] \in \text{\tt\small BlockContext}$ & The \ith block of method $f$ invoked with self=$s$\\

$f^{block_i}_s[\_,\_,\_]^d \in \text{\tt\small BlockContext}$ & The \ith block of method $f$ invoked with self=$s$ and having depth $d$ counting from zero at the method block; e.g., {\tt f [|x| [|y|]]} has a method block at depth 0 with {\tt x} and a nested block at depth 1 with {\tt y} \\

$\gamma \in \text{\tt\small MethodContext}^*$ & Stack of method invocations growing to the right\\

$\delta \in \text{\tt\small Object}^*$ &  Operand stack of objects growing to the right\\

$\mathbb{S}$ & The state of the VM system dictionary\\

$(\mathbb{S},\gamma)$ & VM state is the system dictionary and a method invocation stack with zero or more elements\\

$(\mathbb{S}, \gamma) \Rightarrow (\mathbb{S}', \gamma')$ & VM state transition\\

$(\mathbb{S}, \gamma) \Rightarrow^* (\mathbb{S}', \gamma')$ & Zero-or-more state transitions\\

$f_s[ip,l_0,..l_{n-1},\delta]$ & Method invocation context that derived from sending message $f$ to receiver $s$ (self);  $f \in \text{\tt\small MethodContext}$; $l_i$ is local variable or argument, indexed from 0 and arguments first; $\delta$ is the operand stack; $f$ {\em can also represent a nested code block not just a  method} \\

$f[ip,l_0,..l_{n-1},\delta]$ & Same as previous but the receiver is unknown or irrelevant \\

$f[ip,\_,\_]$ & A method invitation context with ``don't care'' for locals and operand stack\\

\end{tabular}
\end{center}
\vspace{-10pt}
\caption{\small Smalltalk VM Bytecode Specification Notation}
\label{acfg}
\end{figure} 

\begin{figure}
\begin{center}
\begin{tabular}[t]{|r|l|}
\hline
{\bf Bytecode Instruction} & {\bf Transition} \\
\hline
{\em initial state} &
\begin{minipage}[t]{.7\linewidth}
$state_0 = (\mathbb{S}[\text{\tt nil}, \text{\tt true}, \text{\tt false}, \text{\tt Transcript}], \text{\tt main}_{m}[0,\epsilon,\epsilon])$\\
for $m \in \text{\tt MainClass}$; program terminates if $\exists~ state_0 \Rightarrow^* (\mathbb{S'}, \epsilon)$ 
\end{minipage}\\
\hline
{\tt nil}  & $(\mathbb{S}, \gamma f[ip,\_,\delta]) ~\Rightarrow~ (\mathbb{S}, \gamma f[ip+1,\_,\delta\, \text{\tt nil}])$\\

{\tt self} & $(\mathbb{S},\gamma f_s[ip,\_,\delta]) ~\Rightarrow~ (\mathbb{S},\gamma f_s[ip+1,\_,\delta \,s])$ \\

{\tt true} & $(\mathbb{S},\gamma f[ip,\_,\delta]) ~\Rightarrow~ (\mathbb{S},\gamma f[ip+1,\_,\delta \,\text{\tt true}])$\\

{\tt false} & $(\mathbb{S},\gamma f[ip,\_,\delta]) ~\Rightarrow~ (\mathbb{S},\gamma f[ip+1,\_,\delta \,\text{\tt false}])$\\

{\tt push\_char} $c$ & $(\mathbb{S},\gamma f[ip,\_,\delta]) ~\Rightarrow~ (\mathbb{S},\gamma f[ip+3,\_,\delta \,c])$]\\

{\tt push\_int} $i$ & $(\mathbb{S},\gamma f[ip,\_,\delta]) ~\Rightarrow~ (\mathbb{S},\gamma f[ip+5,\_,\delta \,i])$\\

{\tt push\_float} $i$ & $(\mathbb{S},\gamma f[ip,\_,\delta]) ~\Rightarrow~ (\mathbb{S},\gamma f[ip+5,\_,\delta \, \text{\em intBitsToFloat}(i)])$\\

{\tt push\_field} $i$ & $(\mathbb{S},\gamma f_s[ip,\_,\delta]) ~\Rightarrow~ (\mathbb{S}, \gamma f_s[ip+3,\_,\delta \,s_{field_i}])$ \\

{\tt push\_local} $0, i$ & $(\mathbb{S},\gamma f[ip,... l_i ...,\delta]) ~\Rightarrow~ (\mathbb{S},\gamma f[ip+5,...l_i...,\delta \,l_i])$\\

{\tt push\_local} $n > 0, i$ &
\begin{minipage}[t]{.78\linewidth}
$(\mathbb{S},\gamma g^{block}[\_,... {\bm l_i} ...,\_]^{d-n} \,...\, g^{block'}[ip,\_,\_]^{d-1}\,...\, g^{block''}[ip,\_,\delta]^{d}) ~\Rightarrow\\
(\mathbb{S},\gamma\, ... \,g^{block''}[ip+5,\_,\delta {\bm l_i}]^{d})$
\end{minipage} \\

{\tt push\_literal} $i$ & $(\mathbb{S},\gamma f[ip,\_,\delta]) ~\Rightarrow~ (\mathbb{S},\gamma f[ip+3,\_,\delta \,f_{literal_i}])$ \\

{\tt push\_global} $i$  & $(\mathbb{S},\gamma f[ip,\_,\delta]) ~\Rightarrow~ (\mathbb{S},\gamma f[ip+3,\_,\delta \,\mathbb{S}[f_{literal_i}]])$ \\

{\tt push\_array} $n$  &  $(\mathbb{S},\gamma f[ip,\_,\delta\,a_1..a_n]) ~\Rightarrow~ (\mathbb{S}, \gamma f[ip+3,\_,\delta A])$ where $A = Array(a_1..a_n)$ \\

{\tt store\_field} $i$ & $(\mathbb{S}, \gamma f_s[ip,\_,\delta \,{\bf v}]) ~\Rightarrow~ (\mathbb{S}[s_{field_i} = {\bf v}],\gamma f_s[ip+3,\_,\delta\, {\bf v}])$ \\

{\tt store\_local} $n,i$ & $(\mathbb{S},\gamma f[ip, ...l_i...,\delta \,{\bf v}]) ~\Rightarrow~ (\mathbb{S},\gamma f[ip+5,...l_{i-1} {\bf v} \,l_{i+1}...,\delta \,{\bf v}])$ \\

{\tt pop} & $(\mathbb{S},\gamma f[ip,\_,\delta \,v]) ~\Rightarrow~ (\mathbb{S},\gamma f[ip+1,\_,\delta])$\\
\hline

{\tt send} $n,i$ & 
\begin{minipage}[c]{.78\linewidth}
$(\mathbb{S},\gamma f[ip,\_,\delta \,r\, p_1 .. p_{n}]) \Rightarrow 
(\mathbb{S},\gamma f[ip+5,\_,\delta] ~(r_{class}\,{\small \bowtie} \,f_{literal_i})_r[0,p_1 .. p_{n},\epsilon])$
\end{minipage}\\

{\tt send\_super} $n,i$ & 
\begin{minipage}[c]{.78\linewidth}
$(\mathbb{S},\gamma f[ip,\_,\delta \,r\, p_1 .. p_{n}]) \Rightarrow 
(\mathbb{S},\gamma f[ip+5,\_,\delta] ~(r_{superclass}\,{\small \bowtie} \,f_{literal_i})_r[0,p_1 .. p_{n},\epsilon])$
\end{minipage}\\

{\tt block} $i$  & $(\mathbb{S},\gamma f[ip,\_,\delta]) ~\Rightarrow~ (\mathbb{S},\gamma f[ip+3,\_,\delta \,f^{block_i}_s])$\\

{\tt block\_return} &  $(\mathbb{S},\gamma f[ip,\_,\delta]~g^{block}[\_,\_,\delta' \,{\bf v}]) ~\Rightarrow~ (\mathbb{S},\gamma f[ip,\_,\delta \,{\bf v}])$\\

({\em local method}) ~~{\tt return} & $(\mathbb{S},\gamma f[ip,\_,\delta] ~g[\_,\_,\delta' \,{\bf v}]) ~\Rightarrow~ (\mathbb{S},\gamma f[ip,\_,\delta \,{\bf v}])$\\

({\em nonlocal method}) ~~{\tt return} & $(\mathbb{S},\gamma f[ip,\_,\delta] ~g_s[\_,\_,\_]~ ... ~h[\_,\_,\_] ~ g^{block}_s[\_,\_,\delta' \,{\bf v}]) ~\Rightarrow~ (\mathbb{S},\gamma f[ip,\_,\delta \,{\bf v}])$\\

\hline

{\tt dbg} $i, loc$ &
\begin{minipage}[t]{.76\linewidth}
$(\mathbb{S},\gamma f[ip,\_,\_])\Rightarrow
 (\mathbb{S}[\text{\it file}\text{=}f_{literal_i}, \text{\it line}\text{=}loc[31\text{:}8], \text{\it col}\text{=}loc[7\text{:}0]],\gamma f[ip+7,\_,\_])$ \\
Set VM current filename to $f_{literal_i}$ and split $loc$ into char position (indexed from 0) from lower 8 bits and line number  from the upper 24 bits.
\end{minipage}\\
\hline
\end{tabular}
\end{center}
\vspace{-10pt}
\caption{Smalltalk VM State Transition Rules}
\label{default}
\end{figure}%

%------------CODE GEN---------------------

\begin{figure}
\begin{center}
\begin{tabular}[t]{|r|l| l |}
\hline
{\bf Smalltalk fragment} & {\bf Visitor method result} & {\bf Side-effects}\\
\hline
$\epsilon$ & $\epsilon$ (object {\tt Code.None}) & \\

{\tt class T : S [ ]} & $\epsilon$ & \\

$main$  & 
\begin{minipage}[t]{0.25\linewidth}
$main$\\
{\tt self\\
return}
\end{minipage} & \\

{\tt f <primitive:\#}{\it primitive-name}{\tt >} & $\epsilon$ & \\

{\tt f [ }$body$ {\tt ]} & $\epsilon$&
\begin{minipage}[t]{0.35\linewidth}
$\text{\tt f}_{\text{\it code}} =$ \\
\parbox{20pt}{~}$body$\\
\parbox{20pt}{~}{\tt self\\
\parbox{20pt}{~}return}
\end{minipage} \\

{\it operator} {\tt [ }{\it body} {\tt ]} & $\epsilon$&
\begin{minipage}[t]{0.35\linewidth}
$\text{\it operator}_{\text{\it code}} =$ \\
\parbox{20pt}{~}$body$\\
\parbox{20pt}{~}{\tt self\\
\parbox{20pt}{~}return}
\end{minipage} \\

{\tt a:\,x b:\,y $...$ c:\,z [ }{\it body} {\tt ]}  & $\epsilon$&
\begin{minipage}[t]{0.35\linewidth}
$\text{\tt a:b:c:}_{\text{\it code}} =$ \\
\parbox{20pt}{~}$body$\\
\parbox{20pt}{~}{\tt self\\
\parbox{20pt}{~}return}
\end{minipage} \\

$\underbrace{\text{\tt [$args$| |$locals$|  ]}}_{\text{\tt f}^{block_i}}$ & {\tt block }$i$ &
\begin{minipage}[t]{0.35\linewidth}
$\text{\tt f}_{block_i} =$\\
\parbox{20pt}{~}{\tt nil \\
\parbox{20pt}{~}block\_return}
\end{minipage} \\

$\underbrace{\text{\tt [ $body$ ]}}_{\text{\tt f}^{block_i}}$ & {\tt block }$i$ &
\begin{minipage}[t]{0.35\linewidth}
$\text{\tt f}_{block_i}=$\\
\parbox{20pt}{~}$body$\\
\parbox{20pt}{~}{\tt block\_return}
\end{minipage} \\
\hline
\end{tabular}
\end{center}
\vspace{-10pt}
\caption{Smalltalk Compilation Rules}
\label{default}
\end{figure}%


\begin{minipage}[t]{0.25\linewidth}
\end{minipage} 

\begin{minipage}[t]{0.25\linewidth}
\begin{alltt}
\end{alltt}
\end{minipage} 

\end{document}